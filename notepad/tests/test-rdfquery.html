<!DOCTYPE html>
<html xmlns:dc="http://purl.org/dc/elements/1.1/">
<head>

<script src="../external/qunit.js" type="text/javascript"></script>
<link href="../external/qunit.css" type="text/css" rel="stylesheet" media="screen" />
<script src="../external/jsmockito-1.0.4.js" type="text/javascript"></script>
<script src="../external/jshamcrest-0.5.2.js" type="text/javascript"></script>
<script src="qunit-additions.js" type="text/javascript"></script>

<script src="../external/jquery-1.7.2.js" type="text/javascript"></script>
<script src="../external/jquery.rdfquery.rules-1.0.js" type="text/javascript"></script>

<script>
    $(document).ready(function() {

        JsMockito.Integration.QUnit();
        JsHamcrest.Integration.QUnit();

        var ns = {
            rdf: "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
            rdfs: "http://www.w3.org/2000/01/rdf-schema#",
            xsd: "http://www.w3.org/2001/XMLSchema#",
            dc: "http://purl.org/dc/elements/1.1/",
            foaf: "http://xmlns.com/foaf/0.1/",
            cc: "http://creativecommons.org/ns#",
            vcard: "http://www.w3.org/2001/vcard-rdf/3.0#",
            ex: "http://www.example.com/",
            owl: "http://www.w3.org/2002/07/owl#",
        };

        module("rdfquery.js");

        test("can create a URI", function() {
            var uri = $.uri('http://example.com/resource#fragment');
            equal(uri,'http://example.com/resource#fragment');
        });

        test("can create a literal", function() {
            var literal = $.rdf.literal('1');
            equal(literal.toString(), '"1"^^<http://www.w3.org/2001/XMLSchema#integer>');

            literal = $.rdf.literal('"a"');
            equal(literal.toString(), '"a"');

            literal = $.rdf.literal('"a quoted literal with a \\" (an escaped double quote)"');
            equal(literal.toString(), '"a quoted literal with a \\" (an escaped double quote)"');

            // equal($.rdf.literal('a non-quoted string with a " (a quote character)').toString(),
            //     '"a non-quoted string with a \\" (a quote character)"');

            // equal($.rdf.literal('"\\\\""').toString(), '"\\""');

            // BUG: The following test fails if the previous test is not executed right before it
            // http://code.google.com/p/rdfquery/issues/detail?id=30
            equal($.rdf.literal('"\\""').toString(), '"\\""');
        });
        
        test("can create a resource", function() {
            var resource = $.rdf.resource('rdf:foo', {namespaces: {rdf: "http://www.w3.org/1999/02/22-rdf-syntax-ns#"}});
            equal(resource.value.toString(), "http://www.w3.org/1999/02/22-rdf-syntax-ns#foo");
        });

        test("can create a CURIE", function() {
            var uri = "http://www.w3.org/1999/02/22-rdf-syntax-ns#foo";
            var curie = $.createCurie(uri, {namespaces: {rdf: "http://www.w3.org/1999/02/22-rdf-syntax-ns#"}});
            equal(curie,'rdf:foo');
        });

        test("can create a new triple", function() {
            expect(4);
            var triple = $.rdf.triple($.rdf.blank('[]'), $.rdf.label, $.rdf.literal('"foo"'));
            equal(triple.subject.type,'bnode');
            equal(triple.property,$.rdf.label);
            equal(triple.object.value,'foo');
            
            triple = $.rdf.triple($.rdf.resource('<http://example.com/foo>'), $.rdf.label, $.rdf.literal('"foo"'));
            equal(triple.subject.type,'uri');
        
        });

        // test("can create a new triple with well known namespaces", function() {
        //     var triple = $.rdf.triple($.rdf.blank('[]'), 'rdfs:label', $.rdf.literal('"foo"'));
        //     equal(triple.property,$.rdf.label);
        // });

        function getTriple(label) {
            if (label===undefined) {
                label = "label";
            }
            return $.rdf.triple($.rdf.blank('[]'), $.rdf.label, $.rdf.literal('"'+label+'"'));
        }
        
        test("can add triples to a triplestore", function() {    
            var graph = $.rdf.databank();
            equal(graph.size(),0);
            graph.add(getTriple());
            equal(graph.size(),1);
            deepEqual(graph.triples()[0].subject.type,'bnode');
            graph.add(getTriple('label2'));
            equal(graph.size(),2);
        });

        test("can iterate over triples in a graph", function() {
            var graph = $.rdf.databank();
            graph.add(getTriple());
            equal(graph.triples().length,1, "triples are not of length 1" + graph.triples());
        });

        test("can query triples in a graph", function() {
            var graph = $.rdf.databank();
            graph.add(getTriple());
            var rdf = $.rdf( {databank: graph });
            console.debug(rdf.databank.size());
            console.debug(JSON.stringify(rdf.databank.dump()));
            console.debug(rdf.databank.dump({format: "text/turtle"}));
            equal(rdf.where('?s ?p ?o').length, 1, "the rdf object should contain one triple");
        });

        
        test("can convert triples to SparqlU", function() {    
            var graph = $.rdf.databank();

            graph.add( getTriple('label1') );

            var sparqlu = graph.sparqlu();
            
            ok(sparqlu.indexOf('INSERT') != -1, "can't find INSERT in "+sparqlu);
            ok(sparqlu.indexOf('label1') != -1, "can't find literal label1 in "+sparqlu);

            graph.add( getTriple('label2') );
            sparqlu = graph.sparqlu();
            ok(sparqlu.indexOf('label2') != -1, "can't find literal label2 in "+sparqlu);
        });

        test("can reason with sameAs", function() {
            var rule = $.rdf.rule(['?subject1 owl:sameAs ?subject2', '?subject1 ?p ?o'], '?subject2 ?p ?o', { namespaces: ns });
            data = $.rdf.databank().prefix('owl', ns.owl).prefix('ex', ns.ex);
            data.add('<#me> ex:pred "123"');
            data.add('<#me> owl:sameAs <#me2>');
            equal(data.size(), 2);
            rule.run(data);
            equal(data.size(), 4);
            equal(data.triples()[2], $.rdf.triple('<#me2> ex:pred "123"', { namespaces: ns }));
        });

        test("rdfa", function() {
            //var element = $('<div prefix="notepad: http://www.vonholzen.org/instruct/notepad"> <div about="notepad:s" rel="notepad:p" resource="notepad:o"> <div>');
            var element = $('<p id="http://ex.com#info">This paper was written by <span rel="http://ex.com#creator" resource="#me"><span property="http://ex.com#name">Ben Adida</span>.</span></p>');
            element.appendTo("body");
            $('#main').html('<p>This photo was taken by <span class="author" about="photo1.jpg" property="dc:creator">Mark Birbeck</span>.</p>');
            var rdf = $('#main > p > span').rdf();
            assertThat(rdf.databank.triples().length, equalTo(1), "there should be one triple");
            var dump = rdf.databank.dump({format: "text/turtle"});
            assertThat(dump, containsString("photo1.jpg"));
        });

        
    });
</script>

</head>
<body>
    <h1 id="qunit-header">QUnit example</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <div id="notepad-container"><div id="notepad"/></div>
    <div id="main"/>
</body>

</html>