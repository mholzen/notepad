<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>inStruct - Notepad</title>

<!-- External Dependencies of notepad.js -->
<script src="../external/jquery.js" type="text/javascript"></script>
<script src="../external/jquery-ui.js" type="text/javascript"></script>
<link  href="../external/jquery-ui.css" type="text/css" rel="stylesheet" media="screen" />
<script src="../external/jquery.rdfquery.rules-1.0.js" type="text/javascript"></script>
<script src="../external/jquery.caret.js" type="text/javascript"></script>
<script src="../external/subarray.js" type="text/javascript"></script>
<script src="../external/underscore.js" type="text/javascript"></script>
<script src="../external/underscore.string.min.js" type="text/javascript"></script>
<script src="../external/mustache.js" type="text/javascript"></script>
<script src="../external/jquery.contextMenu.js" type="text/javascript"></script>
<link  href="../external/jquery.contextMenu.css" type="text/css" rel="stylesheet" media="screen" />
<script src="../external/moment.min.js"></script>

<!-- Notepad code -->
<script src="../notepad/console.js" type="text/javascript"></script>
<script src="../notepad/endpoint.js" type="text/javascript"></script>
<script src="../notepad/rdf.js" type="text/javascript"></script>
<script src="../notepad/notepad.js" type="text/javascript"></script>
<script src="../notepad/container.js" type="text/javascript"></script>
<script src="../notepad/label.js" type="text/javascript"></script>
<script src="../notepad/fact.js" type="text/javascript"></script>
<script src="../notepad/container2.js" type="text/javascript"></script>
<script src="../notepad/line.js" type="text/javascript"></script>
<script src="../notepad/sparql.js" type="text/javascript"></script>
<script src="../notepad/column.js" type="text/javascript"></script>
<script src="../notepad/predicate.js" type="text/javascript"></script>

<script src="../templates/templates.js" type="text/javascript"></script>
<script src="../notepad/query.js" type="text/javascript"></script>
<script src="../notepad/template.js" type="text/javascript"></script>

<link href="../css/notepad.css" rel="stylesheet" type="text/css" media="screen" />

<script src="../notepad/display-require-provide.js" type="text/javascript"></script>
<script src="../notepad/suggest-line.js" type="text/javascript"></script>

<script>
var endpoint;
var notepad;
var container;
var line;
var object;
var label;
var predicate;
var predicateLabel;
var toUri = $.notepad.toUri;

var log = console;
console.__proto__.debug = function() { };

$(function() {

    notepad = $("#notepad").notepad().data('notepadNotepad');

    $.notepad.discoverEndpoint(notepad);
    
    container = notepad.getContainer();
    line = notepad.getLines()[0];
    object = line.getObject();

    // TODO: this should move somewhere else.  Not sure where...
    $("[rel='rdfs:label']").on('keyup', function(event) {
        var target = $(event.target);
        if (event.keyCode != 186) { // tech:debt            // also, why?  we could do this at every character pressed
            return;
        }
        var label = target.closest(":notepad-label").data('notepadLabel');
        if (!label) {
            log.error("cannot find a label widget");
            return;
        }

        // We need a label that is in object context
        if (target.closest(".notepad-object3").length == 0) {
            return;
        }
        var predicateLabel = label.getPredicate().getLabel();

        var parts = label.getLiteral().match(/\s*(.+?)\s*:\s*(.*)/);
        if (!parts) {
            log.info("can't extract parts");
            return;
        }
        var predicate = parts[1];
        var remainder = parts[2];

        predicateLabel.searchByLabelLiteral(predicate, function(triples) {
            if (triples.length > 1) {
                log.info("too many results ("+triples.length+")... ignoring");
                log.info(triples.toTurtle());
                return;
            }
            if (triples.length == 0) {
                log.info("no matching results.");
                triples.push( toTriple($.notepad.getNewUri(), "rdfs:label", predicate) );
            }
            log.info(triples.toPrettyString());
            label.getPredicate().getLabel().set(triples[0]);
            label.setLiteral(remainder);
            label.focus();
        });
    });

    $("#triples button").click(function() {
        var removed = notepad.removed().toTurtle();
        $(this).siblings(".delete").text(removed);

        var added = notepad.added().toTurtle();
        $(this).siblings(".update").text(added);
    });
    
    $("#save button").click(function() {
        var removed = notepad.removed();
        var added = notepad.added();
        var command = removed.deleteSparql() + added.insertSparql();

        $("#status").text("Saving...");
        notepad.getEndpoint().execute(command)
            .success(function() {
                $("#status").text('Saved.');
            })
            .error(function() { $("#status").text('error'); });
    });

    $(".debug .toggle").click(function() {
        $(this).siblings().toggleClass('hidden');
    });

    $("#menu").menu().css('display', 'none');

    $("#menu").bind('menuselect', function(event, ui) {
        var uri = $(ui.item[0]).children('a[property="ui:select"]').attr('content');
        eval(uri);
    });

    $("#menu-button").button({
        icons: { primary: "ui-icon-triangle-1-s" },
        text: false
    }).hover(function(event) {
        $("#menu")
        .css('display', 'block')
        .position({
            my: "left top",
            at: "left bottom",
            of: $("#menu-button")
        });        
    });

    $("body").click(function() {
        $("#menu").fadeOut("100");
    });

    $('#notepad').on("focus", ':notepad-label [rel="rdfs:label"]', function(event) {
        $("#menu-button").position({
            my: "right top",
            at: "right top",
            of: $(event.target).closest(".notepad-label")
        });
        line = $(event.target).closest(":notepad-line").data('notepadLine');
        container = $(event.target).closest(":notepad-container").data('notepadContainer');
        label = $(event.target).closest(":notepad-label").data('notepadLabel');

        object = line.getObject();
        predicate = line.getPredicate();
        predicateLabel = predicate.getLabel();

        // This should also update the menu with available contextual functions

        // Menu entries should also be derived from the rdfs:class of the selected URI (e.g. email a person)

    });

    setTimeout(function() { object.focus(); }, 100);

    $("#status").hide();
    $("#status").ajaxStart(function(){
        if ($(this).text() == "") {
            $(this).text("Loading...");
            console.time("load");
        }
        $(this).show();
    });
    $("#status").ajaxSuccess(function(){
        setTimeout(function() {
            $("#status").fadeOut(200);
            setTimeout(function() {
                $("#status").text("");
                console.timeEnd("load");
            }, 200);
        }, 200);
    });
    $("#status").ajaxError(function(){
        $(this).text("Error! (check the console)");
        console.timeEnd("load");
    });

    $("#notepad-toggle").click(function() {
        $("#notepad-toggle-target").toggle();
        $("#notepad-toggle").toggleClass('ui-icon-plus');
        $("#notepad-toggle").toggleClass('ui-icon-minus');
    });

});
</script>
</head>
<body>
    <div id="icons" class="alpha">
        <a href="#"><img src="../images/48/blue-home-icon.png"/><div class="label">home</div></a>
        <a href="#"><img src="../images/48/blue-user-icon.png"/><div class="label">who?</div></a>
        <a href="#"><img src="../images/48/blue-case-icon.png"/><div class="label">what?</div></a>
        <a href="#"><img src="../images/48/blue-clock-icon.png"/><div class="label">when?</div></a>
    </div>
    <a id="help" class="alpha" href="/resource-name-not-yet-defined">
        Help
        <!-- <div rel="rdfs:label">Help</div> --><!-- rel="rdfs:label" could be implied -->
    </a>
    <div id="container">
        <div id="status"></div>
        <div id="notepad">
            <div class="title">
                <span id="notepad-toggle" class="ui-icon ui-icon-plus"></span>
                <span style="display:inline-block; vertical-align: text-top;">
                    <div property="rdfs:label" contenteditable="true">Notepad</div>
                    <div id="notepad-toggle-target" class="table">
                        <div class="row">
                            <div about="notepad:endpoint" class="predicate">
                                <div property="rdfs:label">Endpoint</div>
                            </div>
                            <div property="notepad:endpoint" class="object"></div>
                        </div>
                        
                        <div class="row">
                            <div about="notepad:created" class="predicate">
                                <div property="rdfs:label">Created</div>
                            </div>
                            <div property="notepad:created" class="object"></div>
                        </div>
                    </div>
                </span>
            </div>
        </div>
    </div>

        <div id="triples">
            <button>Triples</button>
            <div class="turtle delete"></div>
            <div class="turtle update"></div>
        </div>
        <div id="save">
            <button id="save">Save</button>
            <div class="status"></div>
        </div>

    <div class="debug">
        <button class="toggle">Show/Hide Debug</button>
        <div id="sparql-results" class="hidden">
            <h4>SPARQL Commands</h4>
            <table id="sparql">
                <tr/>
            </table>
        </div>
        <input id="datepicker"></input>
    </div>

    <button id="menu-button"></button>
    <ul id="menu">
        <!-- TODO: onclick won't catch menu selection via the keyboard -->
        <li><a property="ui:select" content="javascript: predicate.newUri();">New predicate</a></li>
        <li><a property="ui:select" content="javascript: line.element.detach();">Delete line contents and children</a></li>
        <li><a property="ui:select" content="javascript: notepad.open(line.getUri());">Open in notepad</a></li>
    <li class="ui-state-disabled"><a href="#" onclick="javascript: line.recognizePredicate();">Recognize predicate</a></li>
    <li class="ui-state-disabled"><a href="#" onclick="javascript: label.newUri();">New URI</a></li>
    <li class="ui-state-disabled"><a href="#" onclick="javascript: container.filters();">Add filters</a></li>
    <li class="ui-state-disabled"><a href="#" onclick="javascript: line.remove();">Remove line from parent</a></li>
    <li class="ui-state-disabled"><a href="#">Add column</a></li>
    <li class="ui-state-disabled"><a id="search" href="#">Search for/query for keywords ...</a></li>
    <li class="ui-state-disabled">
        <a href="#">Describe ... </a>
        <ul>
            <li><a href="#">Everything</a></li>
            <li><a href="#">Properties</a></li>
            <li><a href="#">Facts</a></li>
        </ul>
    </li>
</ul>


    <!--
    <ul id="predicateMenu" class="contextMenu">
    <li class="toggleDirection">
        <a href="#toggleDirection">Toggle Direction</a>
    </li>
    <li class="delete">
        <a href="#delete">Delete</a>
    </li>
    <li class="edit">
        <a href="#edit">Edit</a>
    </li>
    <li class="cut separator">
        <a href="#cut">Cut</a>
    </li>
    <li class="copy">
        <a href="#copy">Copy</a>
    </li>
    <li class="paste">
        <a href="#paste">Paste</a>
    </li> -->
    <!-- <li class="quit separator">
        <a href="#quit">Quit</a>
    </li> -->
</ul>

</body>
</html>