<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>inStruct - Notepad</title>

<!-- External Dependencies of notepad.js -->
<script src="../external/jquery.js" type="text/javascript"></script>
<script src="../external/jquery-ui.js" type="text/javascript"></script>
<link  href="../external/jquery-ui.css" type="text/css" rel="stylesheet" media="screen" />
<script src="../external/jquery.rdfquery.rules-1.0.js" type="text/javascript"></script>
<script src="../external/jquery.caret.js" type="text/javascript"></script>
<script src="../external/subarray.js" type="text/javascript"></script>
<script src="../external/underscore.js" type="text/javascript"></script>
<script src="../external/underscore.string.min.js" type="text/javascript"></script>
<script src="../external/mustache.js" type="text/javascript"></script>
<script src="../external/moment.min.js"></script>

<!-- Notepad code -->
<script src="../notepad/console.js" type="text/javascript"></script>
<script src="../notepad/endpoint.js" type="text/javascript"></script>
<script src="../notepad/rdf.js" type="text/javascript"></script>
<script src="../notepad/notepad.js" type="text/javascript"></script>
<script src="../notepad/container.js" type="text/javascript"></script>
<script src="../notepad/object.js" type="text/javascript"></script>
<script src="../notepad/literal.js" type="text/javascript"></script>
<script src="../notepad/label.js" type="text/javascript"></script>
<script src="../notepad/urilabel.js" type="text/javascript"></script>
<script src="../notepad/fact.js" type="text/javascript"></script>
<script src="../notepad/container2.js" type="text/javascript"></script>
<script src="../notepad/line.js" type="text/javascript"></script>
<script src="../notepad/sparql.js" type="text/javascript"></script>
<script src="../notepad/column.js" type="text/javascript"></script>
<script src="../notepad/predicate.js" type="text/javascript"></script>

<script src="../templates/templates.js" type="text/javascript"></script>
<script src="../notepad/query.js" type="text/javascript"></script>
<script src="../notepad/template.js" type="text/javascript"></script>

<script src="../notepad/autocomplete.js" type="text/javascript"></script>

<link href="../css/notepad.css" rel="stylesheet" type="text/css" media="screen" />

<script>
var endpoint;
var notepad;
var container;
var line;
var childContainer;
var childLines;
var object;
var urilabel;
var literal;
var predicate;
var predicateLabel;
var toUri = $.notepad.toUri;

var dev = $.notepad.dev;
var test = $.notepad.test;

var log = console;
//console.__proto__.debug = function() { };
function here() { console.log('here'); }

function hashToResource(hash) {
    var fragment = hash.substring(1);
    var resource = new Resource(fragment);
    if (resource.isLiteral()) {
        resource = new Resource(":" + fragment);
    }
    return resource;
}

$(function() {

    var hash = window.location.hash;
    if (hash) {
        $("#notepad").attr('about', hashToResource(hash));
    }

    var defaultEndpoints = [
            'http://' + $.uri.base().authority + ':3030/dev',
            'http://instruct.vonholzen.org:3030/dev'
        ];

    var endpoint = $.notepad.getParameterByName('endpoint') || defaultEndpoints;

    notepad = $("#notepad").notepad({endpoint: endpoint}).data('notepadNotepad');

    $("#notepad").on('keydown', '[contenteditable="true"]', function(event) {
        if (event.keyCode === 32 && event.ctrlKey) {
            var line = $(event.target).closest(":notepad-line").data('notepadLine');
            line.option('describeDepth', 1);
            line.childrenToggle();
            // Must prevent autocomplete from triggering
        }

        if (event.keyCode === 83 && event.altKey) { // Alt/Cmd - S
            var line = $(event.target).closest(":notepad-line").data('notepadLine');
            line.option('describeDepth', 1);
            line.childrenToggle();
            event.preventDefault();
            event.stopPropagation();
            return false;
            // Must prevent autocomplete from triggering
        }

    });
    
    $("#notepad").on('keyup', '.notepad-object3 [contenteditable="true"]', function(event) {
        var target = $(event.target);
        if (event.keyCode != 186 /* colon */ ) {
            return;
        }
        var line = target.closest(":notepad-line");
        if (!line) {
            log.error("cannot find a line widget");
            return;
        }
        line = line.data('notepadLine');
        if (line.isPredicateVisible()) {
            log.info("predicate is already shown.  Ignoring ':'");
            return;
        }
        line.discoverPredicate(event);
    });

    // TODO: this should move somewhere else.  Not sure where...
    $("#notepad-old").on('keyup', '[rel="rdfs:label"]', function(event) {
        var target = $(event.target);
        if (event.keyCode != 186) { // tech:debt            // also, why?  we could do this at every character pressed
            return;
        }
        var label = target.closest(":notepad-urilabel").data('notepadUrilabel');
        if (!label) {
            log.error("cannot find a label widget");
            return;
        }

        var line = target.closest(":notepad-line").data('notepadLine');
        if (!line) {
            log.error("cannot find a line widget");
            return;
        }
        if (line.isPredicateVisible()) {
            log.info("predicate is already shown.  Don't do anything with ':'");
            return;
        }

        // We need a label that is in object context
        if (target.closest(".notepad-object3").length == 0) {
            log.error("can't find object");
            return;
        }
        var predicateLabel = line.getPredicate().getLabel();

        // Should ignore a colon in double, or single quotes
        var parts = label.getLiteral().match(/\s*(.+?)\S:\s*(.*)/);
        if (!parts) {
            log.info("can't extract parts");
            return;
        }
        var predicateTerm = parts[1].trim();
        var remainder = parts[2].trim();

        if (knownScheme(predicateTerm)) {
            console.info(predictTerm + "is a URI.  Ignoring.");
            return;
        }

        var query = new Query($.notepad.templates.find_predicate_label_by_label);
            // Should come from predicateLabel.options.query

        query.execute(predicateLabel.getEndpoint(), {'rdfs:label': predicateTerm}, function(triples) {

            line.showPredicate();

            //label.setLiteral(label.getLiteral() - predicateTerm);     // to get any additional characters typed since search started
            label.setLiteral(remainder);

            if (triples.length == 0) {
                log.info("no matching results.");
                line.newPredicateUri();
                predicateLabel.setLabel(predicateTerm);
                label.getLabelElement().caretToEnd();
                return;
            }
            if (triples.length === 1) {
                log.info("exactly one matching results.  Setting predicate.");

                var direction = triples[0].predicate == 'rdfs:label' ? FORWARD : BACKWARD;
                line.getPredicate().setUriDirection(triples[0].subject, direction);
                predicateLabel.set(triples[0]);

                label.focus();
                return;
            }
            if (triples.length > 1) {
                log.info("more than one result ("+triples.length+")... triggering search");

                line.newPredicateUri();
                predicateLabel.setLabel(predicateTerm);
                predicateLabel.getLabelElement().caretToEnd();
                predicateLabel.getLabelElement().focus();
                predicateLabel.getLabelElement().autocomplete("search", predicateTerm);
                return;
            }
        });
    });

    $("#triples button").click(function() {
        $(this).siblings(".turtle").text(notepad.triples().toTurtle());
    });

    $("#save .preview").click(function() {
        var removed = notepad.removed().toTurtle();
        $(this).siblings(".delete").text(removed);

        var added = notepad.added().toTurtle();
        $(this).siblings(".update").text(added);
    });
    
    $(".debug .toggle").click(function() {
        $(this).siblings().toggleClass('hidden');
    });

    //$('#notepad').on("focus", ':notepad-label [rel="rdfs:label"], :notepad-urilabel [rel="rdfs:label"]', function(event) {
    $('#notepad').on("focus", '[contenteditable="true"]', function(event) {
        container = $(event.target).closest(":notepad-container").data('notepadContainer');

        line = $(event.target).closest(":notepad-line").data('notepadLine');
        predicate = line ? line.getPredicate() : undefined;
        predicateLabel = predicate ? predicate.getLabel() : undefined;

        object = line ? line.getObject() : undefined;
        childContainer = line ? line.getChildContainer() : undefined;
        childLines = childContainer ? childContainer.getLines() : undefined;

        urilabel = $(event.target).closest(":notepad-urilabel").data('notepadUrilabel');

        literal = $(event.target).closest(":notepad-literal").data('notepadLiteral');
    });

        // This should also update the menu with available contextual functions
        // Menu entries should also be derived from the rdfs:class of the selected URI (e.g. email a person)


    $("#status").hide();
    $(document).ajaxStart(function(){
        var status = $("#status");
        if (status.text() == "") {
            status.text("Loading...");
            console.time("load");
        }
        status.show();
    });
    $(document).ajaxStop(function(){
        var status = $("#status");
        setTimeout(function() {
            status.fadeOut(200);
            setTimeout(function() {
                status.text("");
                console.timeEnd("load");
            }, 200);
        }, 200);
    });
    $(document).ajaxError(function(){
        $("#status").text("Error! (check the console)");
        console.timeEnd("load");
    });

    $("#notepad-toggle").click(function() {
        $("#notepad-toggle-target").toggle();
        $("#notepad-toggle").toggleClass('ui-icon-plus');
        $("#notepad-toggle").toggleClass('ui-icon-minus');
    });

    setTimeout(function() {
        notepad.focus();
    }, 500);

});
</script>
</head>
<body>
    <div id="icons" class="alpha">
        <a href="#"><img src="../images/48/blue-home-icon.png"/><div class="label">home</div></a>
        <a href="#"><img src="../images/48/blue-user-icon.png"/><div class="label">who?</div></a>
        <a href="#"><img src="../images/48/blue-case-icon.png"/><div class="label">what?</div></a>
        <a href="#"><img src="../images/48/blue-clock-icon.png"/><div class="label">when?</div></a>
    </div>
    <a id="help" class="alpha" href="/resource-name-not-yet-defined">
        Help
        <!-- <div rel="rdfs:label">Help</div> --><!-- rel="rdfs:label" could be implied -->
    </a>
    <div id="container">
        <div id="status"></div>
        <div id="notepad">
            <div class="title">
                <span id="notepad-toggle" class="ui-icon ui-icon-plus"></span>
                <span style="display:inline-block; vertical-align: text-top;">
                    <div property="rdfs:label" contenteditable="true">Notepad</div>
                    <div id="notepad-toggle-target" class="table">
                        <div class="row">
                            <div about="notepad:endpoint" class="predicate">
                                <div property="rdfs:label">Endpoint</div>
                            </div>
                            <div property="notepad:endpoint" class="object"></div>
                        </div>
                        
                        <div class="row">
                            <div about="notepad:created" class="predicate">
                                <div property="rdfs:label">Created</div>
                            </div>
                            <div property="notepad:created" class="object"></div>
                        </div>
                        <div class="row">
                            <div about="notepad:uri" class="predicate">
                                <div property="rdfs:label">URL</div>
                            </div>
                            <div property="notepad:uri" class="object"></div>
                        </div>

                    </div>
                </span>
            </div>
        </div>
        <div id="save">
            <button class="save">Save</button>
            <button class="preview">Preview...</button>
            <div class="status"></div>
            <div class="turtle delete"></div>
            <div class="turtle update"></div>
        </div>

    </div>
    <div id="triples">
        <button>View page triples...</button>
        <div class="turtle"></div>
    </div>

    <div class="debug">
        <button class="toggle">Show/Hide Debug</button>
        <div id="sparql-results" class="hidden">
            <h4>SPARQL Commands</h4>
            <table id="sparql">
                <tr/>
            </table>
        </div>
        <input id="datepicker"></input>
    </div>

    <span id="control">
        <div id="menu-button">
        </div>
        <ul id="menu">
            <!-- TODO: onclick won't catch menu selection via the keyboard -->
            <li><a property="ui:select" content="javascript: notepad.open(line.getUri());"><span class="ui-icon ui-icon-arrowthick-1-e"></span>Open...</a></li>
            <li><a property="ui:select" content="javascript: line.showPredicate();">Show relationship</a></li>
            <li><a property="ui:select" content="javascript: line.newPredicateUri();">New relationship</a></li>
            <li><a property="ui:select" content="javascript: notepad.remove(line);">Remove line</a></li>
            <li><a property="ui:select" content="javascript: notepad.delete(line);">Delete lines and contents</a></li>
            <li><a property="ui:select" content="javascript: line.addCheckboxToChildLines();">Convert to Todo list</a></li>
            <li class="ui-state-disabled"><a property="ui:select" content="javascript: container.toggleSortable();">Re-order lines</a></li>
            <li class="ui-state-disabled"><a href="#">Add column</a></li>
            <li class="ui-state-disabled">
                <a href="#">View ...</a>
                <ul class="templates">
                </ul>
            </li>
            <li class="ui-state-disabled">
                <a href="#">Search within ...</a>
                <ul>
                    <li><a href="#"><span class="ui-icon ui-icon-check"></span>Labels</a></li>
                    <li><a href="#">Relationships</a></li>
                    <li><a href="#">Everything</a></li>
                </ul>
            </li>

            <li class="ui-state-disabled">
                <a href="#">Describe ... </a>
                <ul>
                    <li><a href="#">Everything</a></li>
                    <li><a href="#">Properties</a></li>
                    <li><a href="#">Facts</a></li>
                </ul>
            </li>
        </ul>
    </span>

</body>
</html>