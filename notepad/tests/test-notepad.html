<!DOCTYPE html> <html> <head>

<!-- Test infrastructure -->
<script src="../external/qunit.js" type="text/javascript"></script>
<link  href="../external/qunit.css" type="text/css" rel="stylesheet" media="screen" />
<script src="../external/jsmockito-1.0.4.js" type="text/javascript"></script>
<script src="../external/jshamcrest-0.5.2.js" type="text/javascript"></script>
<script src="qunit-additions.js" type="text/javascript"></script>

<!-- External Dependencies of the code under test -->
<script src="../external/jquery-1.7.2.js" type="text/javascript"></script>
<script src="../external/jquery-ui.js" type="text/javascript"></script>
<link  href="../external/jquery-ui.css" type="text/css" rel="stylesheet" media="screen" />
<script src="../external/jquery.rdfquery.core-1.0.js" type="text/javascript"></script>
<script src="../external/jquery.rdfquery.rules-1.0.js" type="text/javascript"></script>
<script src="../external-modules/jquery-caret/jquery.caret.js" type="text/javascript"></script>
<script src="../external/subarray.js" type="text/javascript"></script>
<script src="../external/underscore.js" type="text/javascript"></script>

<!-- Code under test -->
<link  href="../css/notepad.css" type="text/css" rel="stylesheet" media="screen" />
<script src="../notepad/notepad.js" type="text/javascript"></script>
<script src="../notepad/notepad-rdf.js" type="text/javascript"></script>
<script src="../notepad/notepad-container.js" type="text/javascript"></script>
<script src="../notepad/notepad-line.js" type="text/javascript"></script>
<script src="../notepad/notepad-sparql.js" type="text/javascript"></script>
<script src="../notepad/notepad-column.js" type="text/javascript"></script>
<script src="../notepad/notepad-object.js" type="text/javascript"></script>
<script src="../notepad/notepad-predicate.js" type="text/javascript"></script>

<!-- Tests -->
<script src="notepad-rdf.js" type="text/javascript"></script>
<script src="notepad-object.js" type="text/javascript"></script>
<script src="notepad-container.js" type="text/javascript"></script>
<script src="notepad.js" type="text/javascript"></script>

<script>
    $(document).ready(function() {

        JsMockito.Integration.QUnit();

        module("rdf.query");
        {
            test("rdf.literal", function() {
            equal($.rdf.literal('"a"').toString(), '"a"');

            equal($.rdf.literal('"\\\\""').toString(), '"\\""');
            // BUG: This test fails if the previous test is not executed
            // http://code.google.com/p/rdfquery/issues/detail?id=30
            equal($.rdf.literal('"\\""').toString(), '"\\""');
            });
        }

        module("given a new div", {
            setup: function() {
                this.div = $("#notepad");
            }
        });
        {
            test("when I create a notepad, it should have initial components", function(){
               this.div.notepad();

               equal(this.div.find("li").length, 1, "should have one line element");
               // TODO: reference to .object makes this too highly coupled?
               equal(this.div.find("li .notepad-object").val(), "", "the first line should be empty");

               var notepad = this.div.data('notepad');
               ok(notepad,"it should have a widget");
               equal(notepad.triples().length,0,"should have zero triples");

               ok(!notepad.contains(new Triple(':a',':b','c')), "it should not contain a random triple");
               
               // The following tests may be too highly coupled
               equal(notepad.getLines().length,1, "should have one line widget");
               ok(this.div.find('li').data('line'), "a line should provide it's widget");
               ok(this.div.find("li .notepad-predicate").attr('rel'), "the first line's predicate uri should be defined");
               ok(this.div.find("li .notepad-predicate").val(), "the first line predicate label should be defined");

               this.div.notepad('destroy');
            });
            test("when I create a notepad, it should be destroyed cleanly", function() {
                this.div.notepad();
                var notepad = this.div.data('notepad');
                notepad.destroy();

                equal(this.div.children().length,0,"it leaves children element");
                ok(!this.div.hasClass('notepad'),"it leaves the class 'notepad'");
                ok(!this.div.attr('about'),"it leaves the attribute 'about'");
            });
        }

        module("given a notepad with one line of text", {
            setup: function() {
                this.div = $("#notepad").notepad();
                this.notepad = this.div.data('notepad');
                this.firstLineElement = this.div.find("li:first");
                this.firstObject = this.div.find("li:first .notepad-object");
                this.firstObject.val("first line").change();

                this.firstLine = this.div.find("li:first").data('line');
                this.line = this.firstLine;
                this.lastLine = this.div.find("li:last").data('line');
            },
            teardown: function() { this.notepad.destroy(); }    
        });
        {
            test("when I indent the first line, then it should not move", function() {
                var parentBefore = this.firstLineElement.parent();
                var result = this.firstLine.indent();
                ok(!result, "it should return false");
                var parentAfter = this.firstLineElement.parent();
                deepEqual(parentAfter, parentBefore, "the parent element of the line should not changed");
            });
            test("when I unindent the first line, then it should not move", function() {
                var parentBefore = this.firstLineElement.parent();
                var result = this.firstLine.unindent();
                ok(!result, "it should return false");
                var parentAfter = this.firstLineElement.parent();
                deepEqual(parentAfter, parentBefore, "the parent element of the line should not changed");
            });
        }

        module("given a notepad with two lines", {
            setup: function() {
                this.div = $("#notepad").notepad();
                this.notepad = this.div.data('notepad');
                this.firstObject = this.div.find("li:first .notepad-object");
                this.firstObject.val("first line").change();

                this.firstObject.caretToEnd();
                this.firstObject.trigger(jQuery.Event("keydown", { keyCode: $.ui.keyCode.ENTER }) );

                this.lastObject = this.div.find("li:last .notepad-object")
                this.lastObject.val("second line").change();

                this.firstLine = this.div.find("li:first").data('line');
                this.line = this.firstLine;
                this.lastLine = this.div.find("li:last").data('line');
            },
            teardown: function() { this.notepad.destroy(); }    
        });
        {
            test("when I delete the predicate label, it should delete the line triple", function() {

                $(".notepad-predicate:first").addClass("delete");

                equal(this.line.getContainerTriple().operation, "delete", "the line triple should be deleted");

                deepEqual(this.notepad.deletedTriples(), [this.line.getContainerTriple()], "the line triple should be in the deleted triples");
            })
            function indentSecondLine(div) {
                var target = div.find("li:last .notepad-object");
                target.trigger(jQuery.Event("keydown", { keyCode: $.ui.keyCode.TAB }) );
            }
            test("when I indent the second line,", function() {
                indentSecondLine(this.div);
                equal(
                    this.lastLine._getContainerUri(),
                    this.firstLine.getUri(),
                    "second line should be under the first");
            });
            test("when I set unrelated RDF,", function() {
                var triplesPre = this.notepad.triples();

                this.notepad.setRdf([new Triple(':aUri',':aPredicate',':anotherUri')]);
                deepEqual(this.notepad.triples(), triplesPre, "the triples should remain the same");
            });
            test("a new line should update labels from RDF", function() {
                this.line._setUri('_:lineUri');
                this.notepad.getContainer()._updateLabelsFromRdf( [ new Triple('_:lineUri','rdfs:label','line label') ] );
                equal(this.line.getLineLiteral(),'line label','line label should be set by RDF retrieved');
            });
            test("a new line should display RDF when setting its URI", function() {
                expect(1);
                this.notepad.endpoint = mock(FusekiEndpoint);
                when(this.notepad.endpoint).getRdf('_:lineUri').then( function() { 
                    start();
                    return ['_:lineUri','rdfs:label','line label'];
                });
                stop();
                this.line.setUri('_:lineUri');

                verify(this.notepad.endpoint).getRdf('_:lineUri');
                ok(true, "test complete");
                // TODO: figure out how (and when) to test that the line label was properly set
                // equal(line.getLineLiteral(),'line label','line label should be set by RDF retrieved');
            });
            test("a notepad should display line RDF", function() {
                this.notepad.setRdf([ new Triple(this.line.getUri(), 'rdfs:label', 'new label') ]);
                equal(this.div.find('li .notepad-object').val(), 'new label', "RDF for line1's label should set the line text");
            });
            test("a notepad should display RDF", function() {
                var uri = this.notepad.getUri();

                this.notepad.endpoint = mock(FusekiEndpoint);
                when(this.notepad.endpoint).getRdfBySubjectObject('_:line1').then( function() {
                    start();
                    return ['_:line1','rdfs:label','line label'];
                });

                this.notepad.setRdf( [ new Triple(uri,'rdf:Seq','_:line1') ] );
                ok(this.div.find('li[about="_:line1"]'), "Should be able to find a line with the URI");
                equal(this.div.find('li[about="_:line1"] .notepad-object').text(), '', "First line should be empty");
            });
            test("a notepad should convert RDF to SPARQLU", function() {
                equal(this.notepad.triples().sparql().length, 1, "it should generate one sparql update command");
            });
            test("when I hit enter at the end of the first line, then it should add a newline before the second line", function() {
                this.firstObject.caretToEnd();
                this.firstObject.trigger(jQuery.Event("keydown", { keyCode: $.ui.keyCode.ENTER }) );

                equal(this.div.find("li:eq(0)").data('line').getLineLiteral(),"first line");
                equal(this.div.find("li:eq(1)").data('line').getLineLiteral(),"");
                equal(this.div.find("li:eq(2)").data('line').getLineLiteral(),"second line");
            });
        }

        module("given a notepad with two lines (first empty, second with a label)", {
            setup: function() {
                this.div = $("#notepad").notepad();
                this.notepad = this.div.data('notepad');
                enterNewLine(this.div);
                this.firstLine = this.div.find("li:first").data('line');
                this.line = this.firstLine;
                this.lastLine = this.div.find("li:last").data('line');
            },
            teardown: function() { this.notepad.destroy(); }
        });
        {
            skippedTest("when I save, then the empty line should save because it has a child", function() {
            });
        }

        module("given a notepad with a line and a child line", {
        });
        {
            skippedTest("when I unindent the second line, then the second line relatinoship to the first line should be deleted", function() {
            });
        }

        module('FusekiEnpoint');
        {
            test("a SPARQL endpoint should clear its content", function() {
                stop();
                expect(2);
                var endpoint = new FusekiEndpoint('http://localhost:3030/test');
                endpoint.clear( function(){
                    ok(true, "endpoint should clear");
                    endpoint.getSubjectsLabelsByLabel('label',function(subjects) {
                        equal(subjects.length,0, "endpoint should be empty after clear");
                        start();
                    });
                }).error( function(){ start(); ok(false,"should not receive an error from Fuseki Server"); });
            });
            test("a SPARQL endpoint should return matching nodes by label", function() {
                expect(2);
                stop();
                var endpoint = new FusekiEndpoint('http://localhost:3030/test');
                endpoint.clear( function(){
                    endpoint.execute("INSERT DATA { <> rdfs:label 'label' }", function(data) {
                        ok(true,"insert should be successful");
                        endpoint.getSubjectsLabelsByLabel('label',function(subjects) {
                            equal(subjects.length,1, "endpoint should have one label");
                            start();
                        });
                    });
                }).error( function(){ start(); ok(false,"should not receive an error from Fuseki Server"); });
            });
        }

        module("rdf extensions", {
            setup: function() {
                this.endpoint = new FusekiEndpoint('http://localhost:3030/test');
            },
        });
        {
            skippedTest("given a predicate p, when I post a triple with that predicate, then I can retrieve the collection of triples where p is the predicate", function(){
                this.endpoint.post(":a :pred :b", function() {
                    this.endpoint.get(":pred", function(triples) {
                        ok(triples.sparql("SELECT ?collection WHERE { :pred rdfs:member ?collection . ?collection rdfs:member :a }"));
                    });
                });
            });
        }
    });
</script>

</head>
<body>
    <h1 id="qunit-header">QUnit example</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <div id="notepad-container"><div id="notepad"/></div>
</body>

</html>